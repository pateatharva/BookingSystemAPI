@page
@model BookingSystemAPI.Pages.DashboardModel
@{
    ViewData["Title"] = "Booking Management Dashboard";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold">Booking Admin Panel</a>
        <div>
            <button id="analyticsBtn" class="btn btn-outline-light me-2 navBtn" onclick="showSection('analytics')">Analytics</button>
            <button id="filtersBtn" class="btn btn-outline-light me-2 navBtn" onclick="showSection('filters')">Filters</button>
            <button id="specialBtn" class="btn btn-outline-light me-2 navBtn" onclick="showSection('special')">Special APIs</button>
            <button id="crudBtn" class="btn btn-outline-light me-2 navBtn" onclick="showSection('crud')">Create</button>
            <button id="tableBtn" class="btn btn-outline-light navBtn" onclick="showSection('table')">All Bookings</button>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <!-- ================= ANALYTICS ================= -->
    <div id="analyticsSection">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Analytics Dashboard</h3>
            <button class="btn btn-primary" onclick="refreshAll()">Refresh</button>
        </div>

        <div class="row text-center mb-4">
            <div class="col-md-3"><div class="card p-3 shadow"><h6>Total</h6><h3 id="total"></h3></div></div>
            <div class="col-md-3"><div class="card p-3 shadow"><h6>Confirmed</h6><h3 id="confirmed" class="text-success"></h3></div></div>
            <div class="col-md-3"><div class="card p-3 shadow"><h6>Pending</h6><h3 id="pending" class="text-warning"></h3></div></div>
            <div class="col-md-3"><div class="card p-3 shadow"><h6>Cancelled</h6><h3 id="cancelled" class="text-danger"></h3></div></div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6"><canvas id="statusChart"></canvas></div>
            <div class="col-md-6"><canvas id="hotelChart"></canvas></div>
        </div>

        <canvas id="trendChart"></canvas>
    </div>

    <!-- ================= FILTERS ================= -->
    <div id="filtersSection" style="display:none;">
        <h3>Combined Filter</h3>

        <div class="row mb-3">
            <div class="col-md-3">
                <select id="statusFilter" class="form-select">
                    <option value="">Select Status</option>
                    <option>Confirmed</option>
                    <option>Pending</option>
                    <option>Cancelled</option>
                </select>
            </div>
            <div class="col-md-3">
                <input id="hotelFilter" class="form-control" placeholder="Hotel Name">
            </div>
            <div class="col-md-3">
                <input type="date" id="fromDate" class="form-control">
            </div>
            <div class="col-md-3">
                <input type="date" id="toDate" class="form-control">
            </div>
        </div>

        <button class="btn btn-primary me-2" onclick="applyCombinedFilter()">Apply</button>
        <button class="btn btn-secondary" onclick="showSection('table')">View Result</button>
    </div>

    <!-- ================= SPECIAL APIs ================= -->
    <div id="specialSection" style="display:none;">
        <h3>Special APIs</h3>

        <div class="row mb-4">
            <div class="col-md-3">
                <input type="date" id="particularDate" class="form-control">
            </div>
            <div class="col-md-2">
                <button class="btn btn-info" onclick="loadParticularDay()">Particular Day</button>
            </div>
            <div class="col-md-2">
                <button class="btn btn-warning" onclick="loadUpcoming()">Upcoming</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-2">
                <input type="number" id="pageNumber" class="form-control" placeholder="Page">
            </div>
            <div class="col-md-2">
                <input type="number" id="pageSize" class="form-control" placeholder="Page Size">
            </div>
            <div class="col-md-2">
                <button class="btn btn-dark" onclick="loadPagination()">Pagination</button>
            </div>
        </div>
    </div>

    <!-- ================= CREATE ================= -->
    <div id="crudSection" style="display:none;">
        <h3>Create Booking</h3>

        <div class="row">
            <div class="col-md-2"><input id="custName" class="form-control" placeholder="Customer"></div>
            <div class="col-md-2"><input id="hotelName" class="form-control" placeholder="Hotel"></div>
            <div class="col-md-2">
                <select id="statusCreate" class="form-select">
                    <option>Confirmed</option>
                    <option>Pending</option>
                    <option>Cancelled</option>
                </select>
            </div>
            <div class="col-md-2"><input type="date" id="checkIn" class="form-control"></div>
            <div class="col-md-2"><input type="date" id="checkOut" class="form-control"></div>
            <div class="col-md-2"><button class="btn btn-success w-100" onclick="createBooking()">Create</button></div>
        </div>
    </div>

    <!-- ================= TABLE ================= -->
    <div id="tableSection" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Bookings</h3>
            <button class="btn btn-primary" onclick="refreshAll()">Refresh</button>
        </div>

        <input type="text" id="searchBox" class="form-control mb-3" placeholder="Search..." onkeyup="instantSearch()">

        <div style="max-height:500px; overflow-y:auto;">
            <table class="table table-bordered table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Customer</th>
                        <th>Hotel</th>
                        <th>Status</th>
                        <th>Check-In</th>
                        <th>Check-Out</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bookingTable"></tbody>
            </table>
        </div>
    </div>

    <!-- ================= EDIT SECTION ================= -->
    <div id="editSection" style="display:none;">
        <div class="card p-4 shadow">
            <h3>Edit Booking</h3>
            <form id="editForm">
                <div class="mb-3">
                    <label>Booking ID (Read-only)</label>
                    <input type="text" id="editId" class="form-control" readonly>
                </div>
                <div class="mb-3">
                    <label>Booking ID</label>
                    <input type="text" id="editBookingId" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Customer Name</label>
                    <input type="text" id="editCustomerName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Hotel Name</label>
                    <input type="text" id="editHotelName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Status</label>
                    <select id="editStatus" class="form-control" required>
                        <option>Confirmed</option>
                        <option>Pending</option>
                        <option>Cancelled</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>Check-in Date</label>
                    <input type="date" id="editCheckInDate" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Check-out Date</label>
                    <input type="date" id="editCheckOutDate" class="form-control" required>
                </div>
                <button type="button" class="btn btn-success" onclick="saveEdit()">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
            </form>
        </div>
    </div>

</div>

<script>

    let allBookingsData = [];
    let statusChart, hotelChart, trendChart;

    document.addEventListener("DOMContentLoaded", function () {
        showSection('analytics');
        refreshAll();
    });

    function showSection(section) {
        document.querySelectorAll("[id$='Section']").forEach(s => s.style.display = "none");
        document.querySelectorAll(".navBtn").forEach(b => b.classList.remove("active"));
        document.getElementById(section + "Section").style.display = "block";
        document.getElementById(section + "Btn").classList.add("active");
    }

    function refreshAll() {
        loadAnalytics();
        loadAllBookings();
    }

    /* ================= ANALYTICS ================= */

    function loadAnalytics() {

        fetch('/api/booking/dashboard-summary')
            .then(res => res.json())
            .then(data => {
                total.innerText = data.totalBookings;
                confirmed.innerText = data.confirmed;
                pending.innerText = data.pending;
                cancelled.innerText = data.cancelled;
            });

        fetch('/api/booking/status-count')
            .then(res => res.json())
            .then(data => {
                if(statusChart) statusChart.destroy();
                statusChart = new Chart(statusChart = document.getElementById("statusChart"), {
                    type: 'pie',
                    data: { labels: data.map(x => x.status), datasets: [{ data: data.map(x => x.count) }] }
                });
            });

        fetch('/api/booking/hotel-count')
            .then(res => res.json())
            .then(data => {
                if(hotelChart) hotelChart.destroy();
                hotelChart = new Chart(document.getElementById("hotelChart"), {
                    type: 'bar',
                    data: { labels: data.map(x => x.status), datasets: [{ data: data.map(x => x.count) }] }
                });
            });

        fetch('/api/booking/trend')
            .then(res => res.json())
            .then(data => {
                if(trendChart) trendChart.destroy();
                trendChart = new Chart(document.getElementById("trendChart"), {
                    type: 'line',
                    data: { labels: data.map(x => x.date), datasets: [{ data: data.map(x => x.count) }] }
                });
            });
    }

    /* ================= TABLE ================= */

    function loadAllBookings() {
        fetch('/api/booking')
            .then(res => res.json())
            .then(data => {
                allBookingsData = data;
                renderTable(data);
            });
    }

    function renderTable(data) {
        bookingTable.innerHTML = "";

        if (!data || data.length === 0) {
            bookingTable.innerHTML = "<tr><td colspan='7' class='text-center'>No Data Found</td></tr>";
            return;
        }

        data.forEach(b => {
            bookingTable.innerHTML += `
            <tr>
                <td>${b.customerName}</td>
                <td>${b.hotelName}</td>
                <td>${b.status}</td>
                <td>${b.checkInDate}</td>
                <td>${b.checkOutDate}</td>
                <td>${b.createdAt}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="openEditForm('${b.id}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteBooking('${b.id}')">Delete</button>
                </td>
            </tr>`;
        });
    }

    function instantSearch() {
        const keyword = searchBox.value.toLowerCase();
        const filtered = allBookingsData.filter(b =>
            b.customerName.toLowerCase().includes(keyword) ||
            b.hotelName.toLowerCase().includes(keyword) ||
            b.status.toLowerCase().includes(keyword)
        );
        renderTable(filtered);
    }

    /* ================= FILTER & SPECIAL ================= */

    function applyCombinedFilter() {
        const status = statusFilter.value;
        const hotel = hotelFilter.value;
        const from = fromDate.value;
        const to = toDate.value;

        let url = `/api/booking/filter?`;
        if(status) url += `status=${status}&`;
        if(hotel) url += `hotel=${hotel}&`;
        if(from) url += `from=${from}&`;
        if(to) url += `to=${to}&`;

        fetch(url)
            .then(res => res.json())
            .then(data => { showSection('table'); renderTable(data); });
    }

    function loadParticularDay() {
        fetch(`/api/booking/by-day?date=${particularDate.value}`)
            .then(res => res.json())
            .then(data => { showSection('table'); renderTable(data); });
    }

    function loadUpcoming() {
        fetch(`/api/booking/upcoming`)
            .then(res => res.json())
            .then(data => { showSection('table'); renderTable(data); });
    }

    function loadPagination() {
        fetch(`/api/booking/paged?page=${pageNumber.value}&pageSize=${pageSize.value}`)
            .then(res => res.json())
            .then(data => { showSection('table'); renderTable(data); });
    }

    /* ================= CRUD ================= */

    function createBooking() {
        const booking = {
            customerName: custName.value,
            hotelName: hotelName.value,
            status: statusCreate.value,
            checkInDate: checkIn.value,
            checkOutDate: checkOut.value,
            createdAt: new Date().toISOString().split('T')[0]
        };

        fetch('/api/booking', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(booking)
        })
        .then(() => {
            alert("Booking Created");
            refreshAll();
            showSection('table');
        });
    }

    function deleteBooking(id) {
        if(!confirm("Delete booking?")) return;

        fetch(`/api/booking/${id}`, { method:'DELETE' })
        .then(() => {
            refreshAll();
        });
    }

    // ================= EDIT BOOKING =================
    function openEditForm(id) {
        fetch(`/api/booking/${id}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('editId').value = data.id;
                document.getElementById('editBookingId').value = data.bookingId;
                document.getElementById('editCustomerName').value = data.customerName;
                document.getElementById('editHotelName').value = data.hotelName;
                document.getElementById('editStatus').value = data.status;
                document.getElementById('editCheckInDate').value = data.checkInDate;
                document.getElementById('editCheckOutDate').value = data.checkOutDate;
                document.getElementById('tableSection').style.display = 'none';
                document.getElementById('editSection').style.display = 'block';
            })
            .catch(error => {
                console.error("Error loading booking:", error);
                alert("Failed to load booking");
            });
    }

    function cancelEdit() {
        document.getElementById('editSection').style.display = 'none';
        document.getElementById('tableSection').style.display = 'block';
    }

    function saveEdit() {
        const id = document.getElementById('editId').value;
        const booking = {
            bookingId: document.getElementById('editBookingId').value,
            customerName: document.getElementById('editCustomerName').value,
            hotelName: document.getElementById('editHotelName').value,
            status: document.getElementById('editStatus').value,
            checkInDate: document.getElementById('editCheckInDate').value,
            checkOutDate: document.getElementById('editCheckOutDate').value
        };

        fetch(`/api/booking/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(booking)
        })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                document.getElementById('editSection').style.display = 'none';
                document.getElementById('tableSection').style.display = 'block';
                loadAllBookings();
            })
            .catch(error => {
                console.error("Error updating booking:", error);
                alert("Failed to update booking");
            });
    }

</script>
